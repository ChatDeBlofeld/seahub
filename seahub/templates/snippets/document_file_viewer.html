{% load i18n %}

var OfficePreviewer = function(repo_id, path, token, commit_id) {
    this.repo_id = repo_id;
    this.path = path;
    // only non-null when viewing in shared links
    this.token = token;
    this.commit_id = commit_id;

    this.status_url = function() {
        var params = {
            repo_id: repo_id,
            commit_id: this.commit_id,
            path: path,
            doctype: 'document'
        };
        if (this.token) {
            params['token'] = this.token;
        }
        return "{% url 'office_convert_query_status' %}?" + $.param(params);
    }
};

OfficePreviewer.prototype.start = function() {
    this.check_status();
    return this;
};

OfficePreviewer.prototype.check_status = function() {
    var _this = this;
    $.ajax({
        context: this,
        url: this.status_url(),
        cache: false,
        dataType: 'json',
        success: function(data) {
            var status = data['status'];
            switch (status) {
                case 'PROCESSING':
                    setTimeout($.proxy(this.check_status, this), 2000);
                    break;
                case 'ERROR':
                    var str = "{% trans "Document convertion failed." %}";
                    $('#file-view').html('<div id="file-view-tip"><p class="error">' + str + '</p></div>');
                    break;
                case 'DONE':
                    this.load_page();
            }
        },
        error: function(xhr, textStatus, errorThrown) {
            var str;
            if (xhr.responseText) {
                str = "{% trans "Document convertion failed." %}";
            } else {
                str = "{% trans "Failed. Please check the network." %}";
            }
            $('#file-view').html('<div id="file-view-tip"><p class="error">' + str + '</p></div>');
        }
    });
};

OfficePreviewer.prototype.load_page = function() {
    var raw_path = '{{ SITE_ROOT }}office-convert/static/{{ repo.id  }}/' + this.commit_id + '{{ path|urlencode  }}/fake.pdf'
    try {
        PDFJS.workerSrc = '{{MEDIA_URL}}js/pdf.worker.js';
        PDFJS.getDocument(raw_path).then(function(pdf) {
            if (pdf.numPages > 50) {
                feedback("{% trans "This file has more than 50 pages, and only the first 50 will be shown here." %}", 'info');
            }
    
            var $loadingTip = $('#pdf .loading-tip');
    
            // show at most 50 pages
            var shownPageCount = pdf.numPages < 50 ? pdf.numPages : 50;
    
            var getPageAndRender = function (pageNumber) {
                pdf.getPage(pageNumber).then(function(page) {
                    var scale = 1.5;
                    var viewport = page.getViewport(scale);
                    var $canvas = $('<canvas class="pdf-page"></canvas>');
                    var canvas = $canvas[0];
    
                    var ctx = canvas.getContext('2d', {alpha: false});
                    var outputScale = getOutputScale(ctx);
    
                    var width = Math.floor(viewport.width);
                    var height = Math.floor(viewport.height);
    
                    canvas.width = width * outputScale.sx;
                    canvas.height = height * outputScale.sy;
                    canvas.style.width = width + 'px';
                    canvas.style.height = height + 'px';
    
                    if (outputScale.scaled) {
                        ctx.scale(outputScale.sx, outputScale.sy);
                    }
    
                    $loadingTip.before($canvas);
                    page.render({
                        canvasContext: ctx,
                        viewport: viewport
                    });
    
                    if (pageNumber < shownPageCount) {
                        pageNumber++;
                        getPageAndRender(pageNumber);
                    } else {
                        // the last page
                        $loadingTip.hide();
                    }
                });
            };
    
            // start from page 1
            getPageAndRender(1);
        });
    
    } catch(e) {
        var tip = "{% trans "You can use IE 10 or other browsers, for example, Firefox, to view it online." %}";
        $('#file-view').html('<div id="file-view-tip"><p>' + tip + '</p></div>');
    }
};

$(function() {
    var commit_id = '{{ current_commit.id }}' || '{{ repo.head_cmmt_id }}';
    $('#file-view').html('<div id="pdf"><span class="loading-icon loading-tip"></span></div>');
    new OfficePreviewer('{{ repo.id }}', '{{ path|escapejs }}', '{{ shared_token }}', commit_id).start();
});

function getOutputScale(ctx) {
    var devicePixelRatio = window.devicePixelRatio || 1;
    var backingStoreRatio = ctx.webkitBackingStorePixelRatio ||
                          ctx.mozBackingStorePixelRatio ||
                          ctx.msBackingStorePixelRatio ||
                          ctx.oBackingStorePixelRatio ||
                          ctx.backingStorePixelRatio || 1;
    var pixelRatio = devicePixelRatio / backingStoreRatio;
    return {
        sx: pixelRatio,
        sy: pixelRatio,
        scaled: pixelRatio !== 1
    };
}

