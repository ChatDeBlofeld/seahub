(this["webpackJsonpseahub-frontend"]=this["webpackJsonpseahub-frontend"]||[]).push([[7],{1680:function(e,t,n){n(75),e.exports=n(1752)},1681:function(e,t,n){"use strict";var a=n(742),i=n(743),s=n(744),o=n(746),r=n(747),c=n(748);e.exports=function e(){var t=[],n=o(),p={},g=!1,O=-1;return w.data=function(e,t){if(r(e))return 2===arguments.length?(j("data",g),p[e]=t,w):d.call(p,e)&&p[e]||null;if(e)return j("data",g),p=e,w;return p},w.freeze=x,w.attachers=t,w.use=function(e){var n;if(j("use",g),null===e||void 0===e);else if("function"===typeof e)r.apply(null,arguments);else{if("object"!==typeof e)throw new Error("Expected usable value, not `"+e+"`");"length"in e?o(e):i(e)}n&&(p.settings=a(p.settings||{},n));return w;function i(e){o(e.plugins),e.settings&&(n=a(n||{},e.settings))}function s(e){if("function"===typeof e)r(e);else{if("object"!==typeof e)throw new Error("Expected usable value, not `"+e+"`");"length"in e?r.apply(null,e):i(e)}}function o(e){var t,n;if(null===e||void 0===e);else{if("object"!==typeof e||!("length"in e))throw new Error("Expected a list of plugins, not `"+e+"`");for(t=e.length,n=-1;++n<t;)s(e[n])}}function r(e,n){var i=C(e);i?(c(i[1])&&c(n)&&(n=a(i[1],n)),i[1]=n):t.push(l.call(arguments))}},w.parse=function(e){var t,n=s(e);if(x(),f("parse",t=w.Parser),h(t))return new t(String(n),n).parse();return t(String(n),n)},w.stringify=function(e,t){var n,a=s(t);if(x(),u("stringify",n=w.Compiler),v(e),h(n))return new n(e,a).compile();return n(e,a)},w.run=N,w.runSync=function(e,t){var n,a=!1;return N(e,t,s),b("runSync","run",a),n;function s(e,t){a=!0,i(e),n=t}},w.process=y,w.processSync=function(e){var t,n=!1;return x(),f("processSync",w.Parser),u("processSync",w.Compiler),y(t=s(e),a),b("processSync","process",n),t;function a(e){n=!0,i(e)}},w;function w(){for(var n=e(),i=t.length,s=-1;++s<i;)n.use.apply(null,t[s]);return n.data(a(!0,{},p)),n}function x(){var e,a,i,s;if(g)return w;for(;++O<t.length;)a=(e=t[O])[0],null,!1!==(i=e[1])&&(!0===i&&(e[1]=void 0),"function"===typeof(s=a.apply(w,e.slice(1)))&&n.use(s));return g=!0,O=1/0,w}function C(e){for(var n,a=t.length,i=-1;++i<a;)if((n=t[i])[0]===e)return n}function N(e,t,a){if(v(e),x(),a||"function"!==typeof t||(a=t,t=null),!a)return new Promise(i);function i(i,o){n.run(e,s(t),(function(t,n,s){n=n||e,t?o(t):i?i(n):a(null,n,s)}))}i(null,a)}function y(e,t){if(x(),f("process",w.Parser),u("process",w.Compiler),!t)return new Promise(n);function n(n,a){var i=s(e);m.run(w,{file:i},(function(e){e?a(e):n?n(i):t(null,i)}))}n(null,t)}}().freeze();var l=[].slice,d={}.hasOwnProperty,m=o().use((function(e,t){t.tree=e.parse(t.file)})).use((function(e,t,n){e.run(t.tree,t.file,(function(e,a,i){e?n(e):(t.tree=a,t.file=i,n())}))})).use((function(e,t){t.file.contents=e.stringify(t.tree,t.file)}));function h(e){return"function"===typeof e&&function(e){var t;for(t in e)return!0;return!1}(e.prototype)}function f(e,t){if("function"!==typeof t)throw new Error("Cannot `"+e+"` without `Parser`")}function u(e,t){if("function"!==typeof t)throw new Error("Cannot `"+e+"` without `Compiler`")}function j(e,t){if(t)throw new Error("Cannot invoke `"+e+"` on a frozen processor.\nCreate a new processor first, by invoking it: use `processor()` instead of `processor`.")}function v(e){if(!e||!r(e.type))throw new Error("Expected node, got `"+e+"`")}function b(e,t,n){if(!n)throw new Error("`"+e+"` finished async. Use `"+t+"` instead")}},1682:function(e,t,n){},1683:function(e,t,n){},1684:function(e,t,n){},1752:function(e,t,n){"use strict";n.r(t);var a=n(3),i=n(5),s=n(32),o=n(7),r=n(6),c=n(2),l=n.n(c),d=n(31),m=n.n(d),h=n(80),f=(n(222),n(51)),u=n(1),j=n(8),v=n(130),b=n(19),p=n(1681),g=n(495),O=n(772),w=n(773),x=n(774),C=n(780),N=n(784),y=n(127),S=n(794),D=n(802),I=n(507),k=n(803).default;var R=p().use(g,{commonmark:!0}).use(w).use(O).use(x,{allowDangerousHTML:!0}).use(N).use(C).use((function(e){var t=y(e,this.data("settings")),n=k(I,{attributes:{input:["type"],li:["className"],code:["className"]},tagNames:["input","code"]});this.Compiler=function(e){var a=D(e,n);return S(a,t)}})),L=(p().use(g,{commonmark:!0}).use(O),n(309)),T=n(312),_=n(311),M=n(187),E=n(4),P=n(10),q=(n(541),n(0)),H=function(e){Object(o.a)(n,e);var t=Object(r.a)(n);function n(e){var i;return Object(a.a)(this,n),(i=t.call(this,e)).handleCommentChange=function(e){i.setState({comment:e.target.value})},i.submitComment=function(){var e=i.state.comment.trim();e.length>0&&(j.a.postComment(u.N,u.J,e).then((function(){i.props.listComments()})).catch((function(e){var t=E.a.getErrorMsg(e);P.a.danger(t)})),i.setState({comment:""}))},i.resolveComment=function(e){j.a.updateComment(u.N,e.target.id,"true").then((function(e){i.props.listComments()})).catch((function(e){var t=E.a.getErrorMsg(e);P.a.danger(t)}))},i.editComment=function(e,t){j.a.updateComment(u.N,e,null,null,t).then((function(e){i.props.listComments()})).catch((function(e){var t=E.a.getErrorMsg(e);P.a.danger(t)}))},i.deleteComment=function(e){j.a.deleteComment(u.N,e.target.id).then((function(e){i.props.listComments()})).catch((function(e){var t=E.a.getErrorMsg(e);P.a.danger(t)}))},i.scrollToQuote=function(e,t,n){i.props.scrollToQuote(e,t,n),i.setState({comment:""})},i.state={showResolvedComment:!0,comment:""},i}return Object(i.a)(n,[{key:"componentWillReceiveProps",value:function(e){if(this.props.commentsList.length<e.commentsList.length){var t=this;setTimeout((function(){t.refs.commentsList.scrollTo(0,1e4)}),100)}}},{key:"render",value:function(){var e=this,t=this.props.commentsList;return Object(q.jsxs)("div",{className:"seafile-comment h-100",children:[Object(q.jsx)("div",{className:"flex-fill o-auto",children:t.length>0?Object(q.jsx)("ul",{className:"seafile-comment-list",ref:"commentsList",children:t.map((function(t,n){return Object(q.jsx)(F,{item:t,showResolvedComment:e.state.showResolvedComment,resolveComment:e.resolveComment,editComment:e.editComment,scrollToQuote:e.scrollToQuote,deleteComment:e.deleteComment},n)}))}):Object(q.jsx)("p",{className:"text-center my-4",children:Object(u.sb)("No comment yet.")})}),Object(q.jsxs)("div",{className:"seafile-comment-footer flex-shrink-0",children:[Object(q.jsx)("textarea",{className:"add-comment-input",value:this.state.comment,placeholder:Object(u.sb)("Add a comment..."),onChange:this.handleCommentChange,clos:"100",rows:"3",warp:"virtual"}),Object(q.jsx)("div",{className:"comment-submit-container",children:Object(q.jsx)(h.a,{className:"submit-comment",color:"primary",size:"sm",onClick:this.submitComment,children:Object(u.sb)("Submit")})})]})]})}}]),n}(l.a.Component),F=function(e){Object(o.a)(n,e);var t=Object(r.a)(n);function n(e){var i;return Object(a.a)(this,n),(i=t.call(this,e)).toggleDropDownMenu=function(){i.setState({dropdownOpen:!i.state.dropdownOpen})},i.convertComment=function(e){R.process(e.comment).then((function(e){var t=String(e);i.setState({comment:t})})),R.process(e.quote).then((function(e){var t=String(e);i.setState({quote:t})}))},i.scrollToQuote=function(){var e=i.props.item;i.props.scrollToQuote(e.newIndex,e.oldIndex,e.quote)},i.toggleEditComment=function(){i.setState({editable:!i.state.editable})},i.updateComment=function(e){var t=i.state.newComment;i.props.item.comment!==t&&i.props.editComment(e.target.id,t),i.toggleEditComment()},i.handleCommentChange=function(e){i.setState({newComment:e.target.value})},i.state={dropdownOpen:!1,comment:"",quote:"",newComment:i.props.item.comment,editable:!1},i}return Object(i.a)(n,[{key:"componentWillMount",value:function(){this.convertComment(this.props.item)}},{key:"componentWillReceiveProps",value:function(e){this.convertComment(e.item)}},{key:"render",value:function(){var e=this.props.item;return e.resolved&&!this.props.showResolvedComment?null:this.state.editable?Object(q.jsxs)("li",{className:"seafile-comment-item",id:e.id,children:[Object(q.jsxs)("div",{className:"seafile-comment-info",children:[Object(q.jsx)("img",{className:"avatar",src:e.avatarUrl,alt:""}),Object(q.jsxs)("div",{className:"reviewer-info",children:[Object(q.jsx)("div",{className:"reviewer-name ellipsis",children:e.name}),Object(q.jsx)("div",{className:"review-time",children:e.time})]})]}),Object(q.jsxs)("div",{className:"seafile-edit-comment",children:[Object(q.jsx)("textarea",{className:"edit-comment-input",value:this.state.newComment,onChange:this.handleCommentChange,clos:"100",rows:"3",warp:"virtual"}),Object(q.jsx)(h.a,{className:"comment-btn",color:"primary",size:"sm",onClick:this.updateComment,id:e.id,children:Object(u.sb)("Update")})," ",Object(q.jsx)(h.a,{className:"comment-btn",color:"secondary",size:"sm",onClick:this.toggleEditComment,children:Object(u.sb)("Cancel")})]})]}):Object(q.jsxs)("li",{className:e.resolved?"seafile-comment-item seafile-comment-item-resolved":"seafile-comment-item",id:e.id,children:[Object(q.jsxs)("div",{className:"seafile-comment-info",children:[Object(q.jsx)("img",{className:"avatar",src:e.avatarUrl,alt:""}),Object(q.jsxs)("div",{className:"reviewer-info",children:[Object(q.jsx)("div",{className:"reviewer-name ellipsis",children:e.name}),Object(q.jsx)("div",{className:"review-time",children:e.time})]}),!e.resolved&&Object(q.jsxs)(L.a,{isOpen:this.state.dropdownOpen,size:"sm",className:"seafile-comment-dropdown",toggle:this.toggleDropDownMenu,children:[Object(q.jsx)(T.a,{className:"seafile-comment-dropdown-btn",children:Object(q.jsx)("i",{className:"fas fa-ellipsis-v"})}),Object(q.jsxs)(_.a,{children:[e.userEmail===u.Gc&&Object(q.jsx)(M.a,{onClick:this.props.deleteComment,className:"delete-comment",id:e.id,children:Object(u.sb)("Delete")}),e.userEmail===u.Gc&&Object(q.jsx)(M.a,{onClick:this.toggleEditComment,className:"edit-comment",id:e.id,children:Object(u.sb)("Edit")}),Object(q.jsx)(M.a,{onClick:this.props.resolveComment,className:"seafile-comment-resolved",id:e.id,children:Object(u.sb)("Mark as resolved")})]})]})]}),e.newIndex>=-1&&e.oldIndex>=-1&&Object(q.jsx)("blockquote",{className:"seafile-comment-content",children:Object(q.jsx)("div",{onClick:this.scrollToQuote,dangerouslySetInnerHTML:{__html:this.state.quote}})}),Object(q.jsx)("div",{className:"seafile-comment-content",dangerouslySetInnerHTML:{__html:this.state.comment}})]})}}]),n}(l.a.Component),J=H,A=(n(1682),function(e){Object(o.a)(n,e);var t=Object(r.a)(n);function n(e){var i;return Object(a.a)(this,n),(i=t.call(this,e)).handleCommentChange=function(e){var t=e.target.value;i.setState({comment:t})},i.submitComment=function(){var e=i.props,t=e.quote,n=e.newIndex,a=e.oldIndex,s=i.state.comment.trim();if(0!==s.length){if(t.length>0){var o={quote:t,newIndex:n,oldIndex:a};j.a.postComment(u.N,u.J,s,JSON.stringify(o)).then((function(){i.props.onCommentAdded()})).catch((function(e){var t=E.a.getErrorMsg(e);P.a.danger(t)}))}else j.a.postComment(u.N,u.J,s).then((function(){i.props.onCommentAdded()})).catch((function(e){var t=E.a.getErrorMsg(e);P.a.danger(t)}));i.setState({comment:""})}},i.setQuoteText=function(e){R.process(e).then((function(e){var t=String(e);i.setState({quote:t})}))},i.state={comment:"",quote:""},i}return Object(i.a)(n,[{key:"componentDidMount",value:function(){this.setQuoteText(this.props.quote)}},{key:"componentWillReceiveProps",value:function(e){this.props.quote!==e.quote&&this.setQuoteText(e.quote)}},{key:"render",value:function(){return Object(q.jsxs)("div",{className:"review-comment-dialog",children:[Object(q.jsx)("div",{children:u.Tb}),Object(q.jsx)("blockquote",{className:"review-comment-dialog-quote",children:Object(q.jsx)("div",{dangerouslySetInnerHTML:{__html:this.state.quote}})}),Object(q.jsx)("textarea",{value:this.state.comment,onChange:this.handleCommentChange}),Object(q.jsxs)("div",{className:"button-group",children:[Object(q.jsx)(h.a,{size:"sm",color:"primary",onClick:this.submitComment,children:Object(u.sb)("Submit")}),Object(q.jsx)(h.a,{size:"sm",color:"secondary",onClick:this.props.toggleCommentDialog,children:Object(u.sb)("Cancel")})]}),Object(q.jsx)("span",{className:"review-comment-dialog-triangle"})]})}}]),n}(l.a.Component)),Q=n(300),Y=n(108),V=n(96),B=n(97),U=n(131),z=n(73),W=(n(1683),function(e){Object(o.a)(n,e);var t=Object(r.a)(n);function n(e){var i;return Object(a.a)(this,n),(i=t.call(this,e)).listReviewers=function(){j.a.listDraftReviewers(i.props.draftID).then((function(e){i.setState({reviewers:e.data.reviewers})}))},i.handleSelectChange=function(e){i.setState({selectedOption:e}),i.Options=[]},i.addReviewers=function(){if(i.state.selectedOption.length>0){i.refs.reviewSelect.clearSelect();for(var e=[],t=0;t<i.state.selectedOption.length;t++)e[t]=i.state.selectedOption[t].email;i.setState({loading:!0,errorMsg:[]}),j.a.addDraftReviewers(i.props.draftID,e).then((function(e){if(e.data.failed.length>0){for(var t=[],n=0;n<e.data.failed.length;n++)t[n]=e.data.failed[n];i.setState({errorMsg:t})}i.setState({selectedOption:null,loading:!1}),e.data.success.length>0&&i.listReviewers()})).catch((function(e){var t=E.a.getErrorMsg(e);P.a.danger(t)}))}},i.deleteReviewer=function(e){var t=e.target.getAttribute("name");j.a.deleteDraftReviewer(i.props.draftID,t).then((function(e){if(200===e.data){for(var n=[],a=0;a<i.state.reviewers.length;a++)i.state.reviewers[a].user_email!==t&&n.push(i.state.reviewers[a]);i.setState({reviewers:n})}})).catch((function(e){var t=E.a.getErrorMsg(e);P.a.danger(t)}))},i.state={reviewers:i.props.reviewers,selectedOption:null,errorMsg:[],loading:!1},i.Options=[],i}return Object(i.a)(n,[{key:"render",value:function(){var e=this,t=this.props.toggleAddReviewerDialog,n=this.state,a=n.reviewers,i=n.errorMsg;return Object(q.jsxs)(Y.a,{isOpen:!0,toggle:t,children:[Object(q.jsx)(V.a,{toggle:t,children:Object(u.sb)("Request a review")}),Object(q.jsxs)(B.a,{children:[Object(q.jsx)("p",{children:Object(u.sb)("Add new reviewer")}),Object(q.jsxs)("div",{className:"add-reviewer",children:[Object(q.jsx)(z.a,{placeholder:Object(u.sb)("Search users..."),onSelectChange:this.handleSelectChange,ref:"reviewSelect",isMulti:!0,className:"reviewer-select"}),this.state.selectedOption&&!this.state.loading?Object(q.jsx)(h.a,{color:"secondary",onClick:this.addReviewers,children:Object(u.sb)("Submit")}):Object(q.jsx)(h.a,{color:"secondary",disabled:!0,children:Object(u.sb)("Submit")})]}),i.length>0&&i.map((function(e){var t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:0;return Object(q.jsxs)("p",{className:"reviewer-select-error error",children:[i[t].email,": ",i[t].error_msg]},t)})),a.length>0&&a.map((function(t){var n=arguments.length>1&&void 0!==arguments[1]?arguments[1]:0;return Object(q.jsxs)("div",{className:"reviewer-select-info",children:[Object(q.jsxs)("div",{className:"d-flex",children:[Object(q.jsx)("img",{className:"avatar reviewer-select-avatar",src:t.avatar_url,alt:""}),Object(q.jsx)("span",{className:"reviewer-select-name ellipsis",children:t.user_name})]}),Object(q.jsx)("i",{className:"fa fa-times",name:t.user_email,onClick:e.deleteReviewer})]},n)}))]}),Object(q.jsx)(U.a,{children:Object(q.jsx)(h.a,{color:"secondary",onClick:t,children:Object(u.sb)("Close")})})]})}}]),n}(l.a.Component)),K=W,G=n(89),Z=n(1771),X=n(1772),$=n(1770),ee=n(1773),te=n(1774),ne=n(33),ae=n.n(ne),ie=n(54),se=n(12),oe=n.n(se);n(540);oe.a.locale(window.app.config.lang);var re=function(e){Object(o.a)(n,e);var t=Object(r.a)(n);function n(e){var i;return Object(a.a)(this,n),(i=t.call(this,e)).onClick=function(e,t,n,a){if(t===i.state.activeItem)return!1;i.props.onHistoryItemClick(a,n,t)},i.onScroll=function(e){var t=e.target.clientHeight,n=e.target.scrollHeight;if(t+e.target.scrollTop+1>=n&&i.props.totalReversionCount>i.perPage*i.state.currentPage){var a=i.state.currentPage+1;i.setState({currentPage:a,loading:!0}),j.a.listFileHistoryRecords(u.N,u.J,a,i.perPage).then((function(e){var t=Object.assign([],i.props.historyList);i.props.onHistoryListChange([].concat(Object(ie.a)(t),Object(ie.a)(e.data.data))),i.setState({loading:!1})})).catch((function(e){var t=E.a.getErrorMsg(e);P.a.danger(t)}))}},i.perPage=25,i.state={currentPage:1,loading:!1},i}return Object(i.a)(n,[{key:"render",value:function(){var e=this;return Object(q.jsx)("div",{className:"history-body",children:Object(q.jsxs)("ul",{onScroll:this.onScroll,className:"history-list-container",children:[this.props.historyList?this.props.historyList.map((function(t){var n=arguments.length>1&&void 0!==arguments[1]?arguments[1]:0,a=arguments.length>2?arguments[2]:void 0,i=n+1;return i===a.length&&(i=n),Object(q.jsx)(ce,{onClick:e.onClick,ctime:t.ctime,className:e.props.activeItem===n?"item-active":"",name:t.creator_name,index:n,preItem:a[i],currentItem:t},n)})):Object(q.jsx)(b.a,{}),this.state.loading&&Object(q.jsx)("li",{className:"reloading-reversion",children:Object(q.jsx)(b.a,{})})]})})}}]),n}(l.a.Component),ce=function(e){Object(o.a)(n,e);var t=Object(r.a)(n);function n(){return Object(a.a)(this,n),t.apply(this,arguments)}return Object(i.a)(n,[{key:"render",value:function(){var e=this,t=oe.a.parseZone(this.props.ctime).format("YYYY-MM-DD HH:mm");return Object(q.jsx)("li",{onClick:function(t){return e.props.onClick(t,e.props.index,e.props.preItem,e.props.currentItem)},className:"history-list-item "+this.props.className,children:Object(q.jsxs)("div",{className:"history-info",children:[Object(q.jsx)("div",{className:"time",children:t}),Object(q.jsxs)("div",{className:"owner",children:[Object(q.jsx)("i",{className:"squire-icon"}),Object(q.jsx)("span",{children:this.props.name})]})]})})}}]),n}(l.a.Component),le=re,de=n(14),me=n(23),he=function e(t){Object(a.a)(this,e);var n=new Date(t.created_at).getTime();if(this.time=oe()(n).format("YYYY-MM-DD HH:mm"),this.id=t.id,this.avatarUrl=t.avatar_url,this.comment=t.comment,this.name=t.user_name,this.userEmail=t.user_email,this.resolved=t.resolved,t.detail){var i=JSON.parse(t.detail);this.newIndex=i.newIndex,this.oldIndex=i.oldIndex,this.quote=i.quote}},fe=(n(216),n(152),n(346),n(1684),n(514)),ue=n(12),je=G.b.toSlateRange,ve=G.b.toDOMNode,be=function(e){Object(o.a)(n,e);var t=Object(r.a)(n);function n(e){var i;return Object(a.a)(this,n),(i=t.call(this,e)).initialContent=function(){switch(u.O){case"open":if(!u.H)return void i.setState({isLoading:!1,isShowDiff:!1});if(!u.ac)return void j.a.getFileDownloadLink(u.N,u.J).then((function(e){j.a.getFileContent(e.data).then((function(e){i.setState({draftContent:e.data,draftOriginContent:e.data,isLoading:!1,isShowDiff:!1})}))}));var e=window.location.hash;if(0===e.indexOf("#history-")){var t,n,a=e.slice(9,49),o=e.slice(50,90);i.setState({isLoading:!1,activeTab:"history"}),j.a.listFileHistoryRecords(u.N,u.J,1,25).then((function(e){var s=e.data.data;i.setState({historyList:s,totalReversionCount:e.data.total_count});for(var r=0,c=s.length;r<c&&(o===s[r].commit_id&&(i.setState({activeItem:r}),t=s[r].path),a===s[r].commit_id&&(n=s[r].path),!t||!n);r++);v.a.all([j.a.getFileRevision(u.N,a,n),j.a.getFileRevision(u.N,o,t)]).then(v.a.spread((function(e,t){v.a.all([j.a.getFileContent(e.data),j.a.getFileContent(t.data)]).then(v.a.spread((function(e,t){i.setDiffViewerContent(t.data,e.data)})))})))}))}else v.a.all([j.a.getFileDownloadLink(u.N,u.J),j.a.getFileDownloadLink(u.N,u.L)]).then(v.a.spread((function(e,t){v.a.all([j.a.getFileContent(e.data),j.a.getFileContent(t.data)]).then(v.a.spread((function(e,t){i.setState({draftContent:e.data,draftOriginContent:t.data,isLoading:!1});var n=Object(s.a)(i);setTimeout((function(){n.getChangedNodes()}),100)})))})));break;case"published":if(!u.ac)return void i.setState({isLoading:!1,isShowDiff:!1});var r=u.uc+"repo/"+u.N+"/"+u.M+"/download?p="+u.L,c=u.uc+"repo/"+u.N+"/"+u.bc+"/download?p="+u.L;v.a.all([j.a.getFileContent(r),j.a.getFileContent(c)]).then(v.a.spread((function(e,t){i.setState({draftContent:e.data,draftOriginContent:t.data,isLoading:!1})})))}},i.onHistoryItemClick=function(e,t,n){var a=t.commit_id,s=e.commit_id,o="history-"+a+"-"+s;i.setURL(o),i.setState({activeItem:n,isLoading:!0}),v.a.all([j.a.getFileRevision(u.N,s,e.path),j.a.getFileRevision(u.N,a,t.path)]).then(v.a.spread((function(e,t){v.a.all([j.a.getFileContent(e.data),j.a.getFileContent(t.data)]).then(v.a.spread((function(e,t){i.setDiffViewerContent(e.data,t.data)})))})))},i.onHistoryListChange=function(e){i.setState({historyList:e})},i.listComments=function(){j.a.listComments(u.N,u.J).then((function(e){var t=[];e.data.comments.forEach((function(e){t.push(new he(e))})),i.setState({commentsList:t})}))},i.addComment=function(e){e.stopPropagation(),i.getQuote(),i.quote&&i.setState({isShowCommentDialog:!0})},i.onCommentAdded=function(){i.listComments(),i.toggleCommentDialog()},i.toggleCommentDialog=function(){i.setState({isShowCommentDialog:!i.state.isShowCommentDialog})},i.getOriginRepoInfo=function(){j.a.getRepoInfo(u.N).then((function(e){i.setState({originRepoName:e.data.repo_name})}))},i.getDraftInfo=function(){"open"===u.O&&j.a.getFileInfo(u.N,u.J).then((function(e){i.setState({draftInfo:e.data})}))},i.getChangedNodes=function(){var e=i.refs.diffViewer.value,t=[],n="";e.map((function(e,a){var i=e.data.diff_state;("diff-added"===i&&"diff-added"!==n||"diff-removed"===i&&"diff-removed"!==n||"diff-replaced"===i&&"diff-replaced"!==n)&&t.push(a),n=e.data.diff_state})),i.setState({changedNodes:t})},i.scrollToChangedNode=function(e){if(0!=i.state.changedNodes.length){"up"===e?i.changeIndex++:i.changeIndex--,i.changeIndex>i.state.changedNodes.length-1&&(i.changeIndex=0),i.changeIndex<0&&(i.changeIndex=i.state.changedNodes.length-1);for(var t=window,n=i.state.changedNodes[i.changeIndex],a=window.viewer.children[n],s=ve(window.viewer,a);-1===s.className.indexOf("diff-")&&"BODY"!==s.tagName;)s=s.parentNode;var o=i.findScrollContainer(s,t);o==t.document.body||o==t.document.documentElement?t.scrollTo(0,s.offsetTop):o.scrollTop=s.offsetTop}},i.findScrollContainer=function(e,t){for(var n,a=e.parentNode,i=["auto","overlay","scroll"];!n&&a.parentNode;){var s=t.getComputedStyle(a).overflowY;if(i.includes(s)){n=a;break}a=a.parentNode}return n||t.document.body},i.scrollToQuote=function(e,t,n){var a=i.refs.diffViewer.value.find((function(n){if(n.data.old_index==t&&n.data.new_index==e)return n}));if(a){var s=ve(window.viewer,a);if(!s)return;var o=window,r=i.findScrollContainer(s,o);r==o.document.body||r==o.document.documentElement?o.scrollTo(0,s.offsetTop):r.scrollTop=s.offsetTop}},i.showDiffViewer=function(){return Object(q.jsxs)("div",{children:[i.state.isShowDiff?Object(q.jsx)(f.a,{scriptSource:u.Qb+"js/mathjax/tex-svg.js",newMarkdownContent:i.state.draftContent,oldMarkdownContent:i.state.draftOriginContent,ref:"diffViewer"}):Object(q.jsx)(f.a,{scriptSource:u.Qb+"js/mathjax/tex-svg.js",newMarkdownContent:i.state.draftContent,oldMarkdownContent:i.state.draftContent,ref:"diffViewer"}),Object(q.jsx)("i",{className:"fa fa-plus-square review-comment-btn",ref:"commentbtn",onMouseDown:i.addComment})]})},i.listReviewers=function(){j.a.listDraftReviewers(u.K).then((function(e){i.setState({reviewers:e.data.reviewers})}))},i.onSwitchShowDiff=function(){if(!i.state.isShowDiff){var e=Object(s.a)(i);setTimeout((function(){e.getChangedNodes()}),100)}i.setState({isShowDiff:!i.state.isShowDiff})},i.toggleDiffTip=function(){i.setState({showDiffTip:!i.state.showDiffTip})},i.toggleAddReviewerDialog=function(){i.state.showReviewerDialog&&i.listReviewers(),i.setState({showReviewerDialog:!i.state.showReviewerDialog})},i.showDiffButton=function(){return Object(q.jsxs)("div",{className:"seafile-toggle-diff",children:[Object(q.jsxs)("label",{className:"custom-switch",id:"toggle-diff",children:[Object(q.jsx)("input",{type:"checkbox",checked:i.state.isShowDiff&&"checked",name:"option",className:"custom-switch-input",onChange:i.onSwitchShowDiff}),Object(q.jsx)("span",{className:"custom-switch-indicator"})]}),Object(q.jsx)(Q.a,{placement:"bottom",isOpen:i.state.showDiffTip,target:"toggle-diff",toggle:i.toggleDiffTip,children:Object(u.sb)("View diff")})]})},i.onPublishDraft=function(){j.a.publishDraft(u.K).then((function(e){i.setState({draftStatus:e.data.draft_status})}))},i.initialDiffViewerContent=function(){j.a.listFileHistoryRecords(u.N,u.J,1,25).then((function(e){i.setState({historyList:e.data.data,totalReversionCount:e.data.total_count}),e.data.data.length>1?v.a.all([j.a.getFileRevision(u.N,e.data.data[0].commit_id,u.J),j.a.getFileRevision(u.N,e.data.data[1].commit_id,u.J)]).then(v.a.spread((function(e,t){v.a.all([j.a.getFileContent(e.data),j.a.getFileContent(t.data)]).then(v.a.spread((function(e,t){i.setState({draftContent:e.data,draftOriginContent:t.data})})))}))):j.a.getFileRevision(u.N,e.data.data[0].commit_id,u.J).then((function(e){j.a.getFileContent(e.data).then((function(e){i.setState({draftContent:e.data,draftOriginContent:""})}))}))}))},i.setDiffViewerContent=function(e,t){i.setState({draftContent:e,draftOriginContent:t,isLoading:!1})},i.setURL=function(e){var t=new fe(window.location.href);t.set("hash",e),window.location.href=t.toString()},i.tabItemClick=function(e){i.state.activeTab!==e&&("history"!==e&&window.location.hash&&i.setURL("#"),"reviewInfo"==e?i.initialContent():"history"==e&&i.initialDiffViewerContent(),i.setState({activeTab:e}))},i.showNavItem=function(e){var t=i.state.commentsList.length;switch(e){case"info":return Object(q.jsx)(Z.a,{className:"nav-item",children:Object(q.jsx)(X.a,{className:ae()({active:"reviewInfo"===i.state.activeTab}),onClick:function(){i.tabItemClick("reviewInfo")},children:Object(q.jsx)("i",{className:"fas fa-info-circle"})})});case"comments":return Object(q.jsx)(Z.a,{className:"nav-item",children:Object(q.jsxs)(X.a,{className:ae()({active:"comments"===i.state.activeTab}),onClick:function(){i.tabItemClick("comments")},children:[Object(q.jsx)("i",{className:"fa fa-comments"}),t>0&&Object(q.jsx)("div",{className:"comments-number",children:t})]})});case"history":return Object(q.jsx)(Z.a,{className:"nav-item",children:Object(q.jsx)(X.a,{className:ae()({active:"history"===i.state.activeTab}),onClick:function(){i.tabItemClick("history")},children:Object(q.jsx)("i",{className:"fas fa-history"})})})}},i.getDomNodeByPath=function(e){for(var t,n=document.querySelector(".viewer-component");"number"===typeof e[0]&&n;)(t=n.children[e[0]]).getAttribute("data-slate-node")||(t=t.children[0]),e.shift(),n=t;return t},i.setBtnPosition=function(){var e=window.getSelection();if(e.rangeCount){var t=e.getRangeAt(0),n=null,a=i.refs.commentbtn.style;try{n=je(window.viewer,t)}catch(r){return void(a.top="-1000px")}if(n&&!de.h.isCollapsed(n)){i.range=n;var s=n.anchor.path.slice();s.pop();var o=i.getDomNodeByPath(s);a.right="0px",a.top=o?"".concat(o.offsetTop,"px"):"-1000px"}else a.top="-1000px"}},i.getQuote=function(){if(i.range){i.quote=Object(f.l)(de.b.fragment(window.viewer,i.range));var e=window.viewer.children[i.range.anchor.path[0]];i.newIndex=e.data.new_index,i.oldIndex=e.data.old_index}},i.renderDiffButton=function(){switch(u.O){case"open":if(!u.H||!u.ac)return;return i.showDiffButton();case"published":if(!u.ac)return;return i.showDiffButton()}},i.renderNavItems=function(){switch(u.O){case"open":return u.H?Object(q.jsxs)($.a,{tabs:!0,className:"review-side-panel-nav",children:[i.showNavItem("info"),i.showNavItem("comments"),i.showNavItem("history")]}):Object(q.jsx)($.a,{tabs:!0,className:"review-side-panel-nav",children:i.showNavItem("info")});case"published":return u.ac?Object(q.jsxs)($.a,{tabs:!0,className:"review-side-panel-nav",children:[i.showNavItem("info"),i.showNavItem("comments")]}):Object(q.jsx)($.a,{tabs:!0,className:"review-side-panel-nav",children:i.showNavItem("info")})}},i.renderContent=function(){switch(u.O){case"open":return u.H?i.showDiffViewer():Object(q.jsx)("p",{className:"error",children:Object(u.sb)("Draft has been deleted.")});case"published":return u.ac?i.showDiffViewer():Object(q.jsx)("p",{className:"error",children:Object(u.sb)("Original file has been deleted.")})}},i.state={draftContent:"",draftOriginContent:"",draftInfo:{},isLoading:!0,isShowDiff:!0,showDiffTip:!1,activeTab:"reviewInfo",commentsList:[],changedNodes:[],originRepoName:"",isShowCommentDialog:!1,activeItem:null,historyList:[],showReviewerDialog:!1,reviewers:[],draftStatus:u.O},i.quote="",i.newIndex=null,i.oldIndex=null,i.changeIndex=-1,i.range=null,i}return Object(i.a)(n,[{key:"componentDidMount",value:function(){this.getOriginRepoInfo(),this.getDraftInfo(),this.listReviewers(),this.listComments(),this.initialContent(),document.addEventListener("selectionchange",this.setBtnPosition)}},{key:"componentWillUnmount",value:function(){document.removeEventListener("selectionchange",this.setBtnPosition)}},{key:"render",value:function(){var e=this.state,t=e.draftInfo,n=e.reviewers,a=e.originRepoName,i=e.draftStatus,s=u.uc+"lib/"+u.N+"/file"+u.J+"?mode=edit",o="published"==this.state.draftStatus,r="open"==this.state.draftStatus&&"rw"==u.pb,c="open"==this.state.draftStatus&&"rw"==u.pb,l=ue(1e3*t.mtime).format("YYYY-MM-DD HH:mm"),d="".concat(u.uc,"profile/").concat(encodeURIComponent(t.last_modifier_email),"/");return Object(q.jsxs)("div",{className:"wrapper",children:[Object(q.jsxs)("div",{id:"header",className:"header review",children:[Object(q.jsxs)("div",{className:"cur-file-info",children:[Object(q.jsx)("div",{className:"info-item file-feature",children:Object(q.jsx)("span",{className:"sf2-icon-review"})}),Object(q.jsxs)("div",{children:[Object(q.jsxs)("div",{className:"info-item file-info",children:[Object(q.jsx)("span",{className:"file-name",children:u.I}),Object(q.jsx)("span",{className:"mx-2 file-review",children:Object(u.sb)("Review")})]}),!o&&t.mtime&&Object(q.jsxs)("div",{className:"last-modification",children:[Object(q.jsx)("a",{href:d,children:t.last_modifier_name}),Object(q.jsx)("span",{className:"mx-1",children:l})]})]})]}),Object(q.jsxs)("div",{className:"button-group",children:[this.renderDiffButton(),c&&Object(q.jsx)("a",{href:s,className:"mx-1",children:Object(q.jsx)(h.a,{className:"file-operation-btn",color:"secondary",children:Object(u.sb)("Edit Draft")})}),r&&Object(q.jsx)("button",{className:"btn btn-success file-operation-btn",title:Object(u.sb)("Publish draft"),onClick:this.onPublishDraft,children:Object(u.sb)("Publish")}),o&&Object(q.jsx)("button",{className:"btn btn-success file-operation-btn",title:Object(u.sb)("Published"),disabled:!0,children:Object(u.sb)("Published")})]})]}),Object(q.jsx)("div",{id:"main",className:"main",ref:"main",children:Object(q.jsxs)("div",{className:"cur-view-container",children:[Object(q.jsx)("div",{className:"cur-view-content",ref:"viewContent",children:this.state.isLoading?Object(q.jsx)("div",{className:"markdown-viewer-render-content article",children:Object(q.jsx)(b.a,{})}):Object(q.jsx)("div",{className:"markdown-viewer-render-content article",children:this.renderContent()})}),Object(q.jsx)("div",{className:"cur-view-right-part",children:Object(q.jsxs)("div",{className:"review-side-panel",children:[this.renderNavItems(),Object(q.jsxs)(ee.a,{activeTab:this.state.activeTab,children:[Object(q.jsx)(te.a,{tabId:"reviewInfo",children:Object(q.jsxs)("div",{className:"review-side-panel-body",children:[Object(q.jsx)(pe,{reviewers:n,toggleAddReviewerDialog:this.toggleAddReviewerDialog}),Object(q.jsx)(ge,{}),u.H&&Object(q.jsx)(we,{commentsList:this.state.commentsList}),!0===this.state.isShowDiff&&this.state.changedNodes.length>0&&Object(q.jsx)(xe,{changedNumber:this.state.changedNodes.length,scrollToChangedNode:this.scrollToChangedNode}),Object(q.jsx)(Oe,{originRepoName:a,draftInfo:t,draftStatus:i})]})}),Object(q.jsx)(te.a,{tabId:"comments",className:"comments",children:Object(q.jsx)(J,{scrollToQuote:this.scrollToQuote,listComments:this.listComments,commentsList:this.state.commentsList,inResizing:!1})}),Object(q.jsx)(te.a,{tabId:"history",className:"history",children:Object(q.jsx)(le,{activeItem:this.state.activeItem,historyList:this.state.historyList,totalReversionCount:this.state.totalReversionCount,onHistoryItemClick:this.onHistoryItemClick,onHistoryListChange:this.onHistoryListChange})})]})]})})]})}),this.state.showReviewerDialog&&Object(q.jsx)(me.a,{children:Object(q.jsx)(K,{showReviewerDialog:this.state.showReviewerDialog,toggleAddReviewerDialog:this.toggleAddReviewerDialog,draftID:u.K,reviewers:n})}),this.state.isShowCommentDialog&&Object(q.jsx)(me.a,{children:Object(q.jsx)(A,{toggleCommentDialog:this.toggleCommentDialog,onCommentAdded:this.onCommentAdded,quote:this.quote,newIndex:this.newIndex,oldIndex:this.oldIndex})})]})}}]),n}(l.a.Component),pe=function(e){Object(o.a)(n,e);var t=Object(r.a)(n);function n(e){return Object(a.a)(this,n),t.call(this,e)}return Object(i.a)(n,[{key:"render",value:function(){var e=this.props.reviewers;return Object(q.jsxs)("div",{className:"review-side-panel-item",children:[Object(q.jsxs)("div",{className:"review-side-panel-header",children:[Object(u.sb)("Reviewers"),Object(q.jsx)("i",{className:"fa fa-cog",onClick:this.props.toggleAddReviewerDialog})]}),e.length>0?e.map((function(e){var t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:0;return Object(q.jsxs)("div",{className:"reviewer-info",children:[Object(q.jsx)("img",{className:"avatar review-side-panel-avatar",src:e.avatar_url,alt:""}),Object(q.jsx)("span",{className:"reviewer-name ellipsis",children:e.user_name})]},t)})):Object(q.jsx)("span",{children:Object(u.sb)("No reviewer yet.")})]})}}]),n}(l.a.Component),ge=function(e){Object(o.a)(n,e);var t=Object(r.a)(n);function n(){return Object(a.a)(this,n),t.apply(this,arguments)}return Object(i.a)(n,[{key:"render",value:function(){return Object(q.jsxs)("div",{className:"review-side-panel-item",children:[Object(q.jsx)("div",{className:"review-side-panel-header",children:Object(u.sb)("Author")}),Object(q.jsxs)("div",{className:"author-info",children:[Object(q.jsx)("img",{className:"avatar review-side-panel-avatar",src:u.h,alt:""}),Object(q.jsx)("span",{className:"author-name ellipsis",children:u.g})]})]})}}]),n}(l.a.Component),Oe=function(e){Object(o.a)(n,e);var t=Object(r.a)(n);function n(e){return Object(a.a)(this,n),t.call(this,e)}return Object(i.a)(n,[{key:"render",value:function(){var e=this.props,t=e.draftStatus,n=e.originRepoName,a=u.jc+"/lib/"+u.N+"/file"+u.L;return Object(q.jsx)("div",{className:"dirent-table-container",children:Object(q.jsxs)("table",{className:"table-thead-hidden",children:[Object(q.jsx)("thead",{children:Object(q.jsxs)("tr",{children:[Object(q.jsx)("th",{width:"25%"}),Object(q.jsx)("th",{width:"75%"})]})}),Object(q.jsx)("tbody",{children:Object(q.jsxs)("tr",{children:[Object(q.jsx)("th",{className:"align-text-top",children:Object(u.sb)("Location")}),Object(q.jsx)("td",{children:"open"===t?Object(q.jsxs)("span",{children:[n,u.J]}):Object(q.jsx)("a",{href:a,className:"text-dark",children:a})})]})})]})})}}]),n}(l.a.Component),we=function(e){Object(o.a)(n,e);var t=Object(r.a)(n);function n(e){return Object(a.a)(this,n),t.call(this,e)}return Object(i.a)(n,[{key:"render",value:function(){var e=this.props.commentsList,t=0;if(e)for(var n=0,a=e.length;n<a;n++)!1===e[n].resolved&&t++;return Object(q.jsxs)("div",{className:"review-side-panel-item",children:[Object(q.jsx)("div",{className:"review-side-panel-header",children:Object(u.sb)("Comments")}),Object(q.jsx)("div",{className:"changes-info",children:Object(q.jsxs)("span",{children:[Object(u.sb)("Unresolved comments:")," ",t]})})]})}}]),n}(l.a.Component),xe=function(e){Object(o.a)(n,e);var t=Object(r.a)(n);function n(e){return Object(a.a)(this,n),t.call(this,e)}return Object(i.a)(n,[{key:"render",value:function(){var e=this;return Object(q.jsxs)("div",{className:"review-side-panel-item",children:[Object(q.jsx)("div",{className:"review-side-panel-header",children:Object(u.sb)("Changes")}),Object(q.jsxs)("div",{className:"changes-info",children:[Object(q.jsxs)("span",{children:[Object(u.sb)("Number of changes:")," ",this.props.changedNumber]}),this.props.changedNumber>0&&Object(q.jsxs)("div",{children:[Object(q.jsx)("i",{className:"fa fa-arrow-circle-up",onClick:function(){e.props.scrollToChangedNode("down")}}),Object(q.jsx)("i",{className:"fa fa-arrow-circle-down",onClick:function(){e.props.scrollToChangedNode("up")}})]})]})]})}}]),n}(l.a.Component);m.a.render(Object(q.jsx)(be,{}),document.getElementById("wrapper"))},540:function(e,t,n){}},[[1680,1,0]]]);
//# sourceMappingURL=draft.chunk.js.map